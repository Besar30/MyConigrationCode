using System.Collections.Concurrent;
using System.Dynamic;
using System.Reflection;

namespace DevHabit.Api.Services;

public sealed class DataShapingService
{
    private static readonly ConcurrentDictionary<Type, PropertyInfo[]> PropertiesCashe=new();
    public  ExpandoObject ShapeData<T>(T entity, string? fields)
    {
        HashSet<string> fieldSet = fields?
                                  .Split(',', StringSplitOptions.RemoveEmptyEntries)
                                  .Select(x => x.Trim())
                                  .ToHashSet(StringComparer.OrdinalIgnoreCase) ?? [];
        PropertyInfo[] propertyInfos = PropertiesCashe.GetOrAdd(typeof(T), t => t.GetProperties(BindingFlags.Public | BindingFlags.Instance));
        if (fieldSet.Any())
        {
            propertyInfos = propertyInfos.Where(p => fieldSet.Contains(p.Name)).ToArray();
        }
        IDictionary<string, object?> shapedObject = new ExpandoObject();
        foreach (PropertyInfo propertyInfo in propertyInfos)
        {
            shapedObject[propertyInfo.Name]=propertyInfo.GetValue(entity);

        }
        return (ExpandoObject)shapedObject;
    }
    public List<ExpandoObject> ShapeCollectionData<T>(IEnumerable<T> entites ,string? fields)
    {
        var fieldSet = fields?
                       .Split(',', StringSplitOptions.RemoveEmptyEntries)
                       .Select(x => x.Trim())
                       .ToHashSet(StringComparer.OrdinalIgnoreCase) ?? [];
      PropertyInfo[] propertyInfos=  PropertiesCashe.GetOrAdd(
            typeof(T),
            t => t.GetProperties(BindingFlags.Public | BindingFlags.Instance));
        if(!fieldSet.Any())
        {
            propertyInfos=propertyInfos.
                          Where(p=>fieldSet.Contains(p.Name)).ToArray();
        }
        propertyInfos = propertyInfos
                      .Where(p => fieldSet.Contains(p.Name))
                      .ToArray();
        List<ExpandoObject> shapedObjects = [];
        foreach(T entity in entites)
        {
            IDictionary<string, object?> shapedObject = new ExpandoObject();
            //apply data shaping
            foreach(PropertyInfo propertyInfo in propertyInfos)
            {
                shapedObject[propertyInfo.Name]=propertyInfo.GetValue(entity);
            }
            shapedObjects.Add((ExpandoObject)shapedObject);
        }
        return shapedObjects;
    }
    public bool Validate<T>(string? fields)
    {
        if (string.IsNullOrWhiteSpace(fields))
        {
            return true;
        }
       var fieldsSet=fields
                                 .Split(',',StringSplitOptions.RemoveEmptyEntries)
                                 .Select(f => f.Trim())
                                 .ToHashSet(StringComparer.OrdinalIgnoreCase);
       PropertyInfo[] propertyInfos=PropertiesCashe.GetOrAdd( typeof(T),t=>t.GetProperties(BindingFlags.Public | BindingFlags.Instance)); 
       return fieldsSet.All(f=>propertyInfos.Any(p=>p.Name.Equals(f,StringComparison.OrdinalIgnoreCase))); 
    }
}
